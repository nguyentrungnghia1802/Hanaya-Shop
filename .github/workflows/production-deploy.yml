name: 🚀 Production Deploy

# Strategic triggering for production
on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
      - '#GUIDE/**'
      - 'deployment/README.md'
      - 'deployment/BRANCH_STRATEGY.md'
      - 'deployment/CICD_SETUP.md'

  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
      - '#GUIDE/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'Force deployment (skip some checks)'
        required: false
        default: false
        type: boolean

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'
  DOCKER_IMAGE: 'assassincreed2k1/hanaya-shop'

jobs:
  # 🔍 Pre-flight validation
  validation:
    name: 🔍 Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      is-pr: ${{ steps.context.outputs.is-pr }}
      deploy-env: ${{ steps.context.outputs.deploy-env }}
      should-deploy: ${{ steps.context.outputs.should-deploy }}
      image-tag: ${{ steps.context.outputs.image-tag }}
      
    steps:
      - name: Analyze deployment context
        id: context
        run: |
          # Determine deployment context
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "is-pr=true" >> $GITHUB_OUTPUT
            echo "deploy-env=staging" >> $GITHUB_OUTPUT
            echo "should-deploy=false" >> $GITHUB_OUTPUT  # PR = test only
            echo "image-tag=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "deploy-env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "image-tag=manual-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "deploy-env=production" >> $GITHUB_OUTPUT
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "image-tag=prod-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Display deployment info
        run: |
          echo "🚀 Production Deployment Pipeline"
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Is PR: ${{ steps.context.outputs.is-pr }}"
          echo "Environment: ${{ steps.context.outputs.deploy-env }}"
          echo "Will Deploy: ${{ steps.context.outputs.should-deploy }}"
          echo "Image Tag: ${{ steps.context.outputs.image-tag }}"

  # 🧪 Comprehensive Testing
  comprehensive-tests:
    name: 🧪 Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: validation
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: hanaya_shop_prod_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, redis
          coverage: xdebug
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies and build
        run: |
          # Install with dev dependencies for testing phase (includes Faker, PHPUnit)
          # Production Docker build will use --no-dev
          composer install --no-interaction --prefer-dist --optimize-autoloader
          npm ci --production=false
          npm run build

      - name: Configure production-like environment
        run: |
          cp .env.example .env
          php artisan key:generate
          
          # Production-like database config
          sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=hanaya_shop_prod_test/' .env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=root/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=password/' .env
          
          # Testing-friendly configuration that works with production-like setup
          echo "APP_ENV=testing" >> .env
          echo "APP_DEBUG=true" >> .env
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "REDIS_PORT=6379" >> .env
          echo "CACHE_DRIVER=array" >> .env
          echo "SESSION_DRIVER=array" >> .env
          echo "QUEUE_CONNECTION=sync" >> .env
          echo "MAIL_MAILER=array" >> .env
          echo "MAIL_FROM_ADDRESS=noreply@hanaya-shop.com" >> .env
          echo 'MAIL_FROM_NAME="Hanaya Shop"' >> .env
          echo "BCRYPT_ROUNDS=4" >> .env

      - name: Prepare application
        run: |
          # Create all necessary directories
          mkdir -p storage/framework/{cache/data,sessions,views,testing}
          mkdir -p storage/{app/public,logs}
          mkdir -p bootstrap/cache
          chmod -R 755 storage bootstrap/cache
          
          # Clear any existing cache before optimization
          php artisan cache:clear || echo "Cache already clear"
          php artisan config:clear || echo "Config already clear"
          php artisan route:clear || echo "Routes already clear"
          php artisan view:clear || echo "Views already clear"
          
          # Optimize for production-like testing
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      - name: Run database migrations
        run: |
          php artisan migrate --force
          
          # Seed basic data for feature tests
          php artisan db:seed --force --class=DatabaseSeeder || echo "⚠️ Seeding failed or not needed"

      - name: Execute comprehensive test suite
        id: test-execution
        continue-on-error: true
        run: |
          echo "🧪 Running comprehensive tests..."
          
          # Set test status tracking
          echo "test-status=success" >> $GITHUB_OUTPUT
          
          # Core functionality tests (without parallel to avoid race conditions)
          echo "🧪 Running Unit Tests..."
          if ! php artisan test --testsuite=Unit --stop-on-failure; then
            echo "❌ Unit tests failed!"
            echo "test-status=unit-failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ Unit tests passed"
          
          # Wait a moment for stability and clear caches
          sleep 2
          php artisan cache:clear
          php artisan config:clear
          
          # Essential feature tests with proper environment setup
          echo "🧪 Running Essential Feature Tests..."
          export APP_ENV=testing
          export DB_CONNECTION=mysql
          if ! php artisan test --testsuite=Feature --filter="ExampleTest|AuthenticationTest|PasswordConfirmationTest|PasswordUpdateTest|RegistrationTest" --stop-on-failure --verbose --env=testing; then
            echo "❌ Essential feature tests failed!"
            echo "test-status=feature-failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ All tests passed successfully"
      
      - name: Handle test failures
        if: steps.test-execution.outcome == 'failure'
        run: |
          echo "⚠️ Tests failed in production deploy pipeline"
          echo "Test Status: ${{ steps.test-execution.outputs.test-status }}"
          
          if [[ "${{ steps.test-execution.outputs.test-status }}" == "unit-failed" ]]; then
            echo "❌ Unit test failures indicate code quality issues"
            echo "🔴 Blocking deployment due to unit test failures"
            exit 1
          elif [[ "${{ steps.test-execution.outputs.test-status }}" == "feature-failed" ]]; then
            echo "❌ Feature test failures indicate integration issues"
            echo "🔴 Blocking deployment due to feature test failures"
            exit 1
          fi
          
      - name: Test coverage and quality report
        if: steps.test-execution.outcome == 'success'
        run: |
          echo "📊 Test Summary:"
          echo "✅ Unit Tests: Passed"
          echo "✅ Feature Tests: Passed"
          echo "🎯 Quality Gate: Met"
          echo "🚀 Ready for deployment"
          
          # Code quality checks with better error handling
          echo "🎨 Running Laravel Pint checks..."
          if ! ./vendor/bin/pint --test; then
            echo "❌ Code style issues found!"
            echo "💡 Run './vendor/bin/pint' locally to fix"
            exit 1
          fi
          echo "✅ Code style checks passed"
          
          # Security audit with better handling
          echo "🔒 Running security audit..."
          if ! composer audit; then
            echo "⚠️ Security vulnerabilities detected - review required"
            # Don't fail on security issues, just warn
          fi
          
          if npm audit --audit-level=high; then
            echo "✅ NPM security check passed"
          else
            echo "⚠️ NPM vulnerabilities detected"
          fi

      - name: Performance tests
        continue-on-error: true
        run: |
          echo "🚀 Running performance tests..."
          # Basic performance check
          time php artisan config:cache
          time php artisan route:cache
          time php artisan view:cache

  # 🐳 Docker Build & Push
  docker-build:
    name: 🐳 Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests]
    environment: ${{ needs.validation.outputs.deploy-env }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=commit-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.validation.outputs.image-tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.validation.outputs.image-tag }}

      - name: Image security scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'

  # 🚀 Production Deployment
  deploy:
    name: 🚀 Deploy to Production
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests, docker-build]
    if: needs.validation.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.validation.outputs.deploy-env }}
      url: ${{ needs.validation.outputs.deploy-env == 'production' && 'http://www.hanayashop.com' || 'http://staging.hanayashop.com' }}
    
    steps:
      - name: Setup SSH Authentication
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Production Server
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=30 -o StrictHostKeyChecking=yes \
              ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'DEPLOYMENT_SCRIPT'
            
            set -euo pipefail  # Strict error handling
            
            echo "� Starting production deployment..."
            echo "Target environment: ${{ needs.validation.outputs.deploy-env }}"
            echo "Image tag: ${{ needs.validation.outputs.image-tag }}"
            
            # Navigate to application directory
            cd /opt/hanaya-shop || {
              echo "❌ Application directory not found at /opt/hanaya-shop"
              exit 1
            }
            
            echo "📁 Current directory: $(pwd)"
            echo "🐳 Current Docker status:"
            docker ps --filter name=hanaya --format "table {{.Names}}\t{{.Status}}" || echo "No containers running"
            
            # Stop conflicting services
            echo "🛑 Stopping nginx to free port 80..."
            sudo systemctl stop nginx 2>/dev/null || echo "nginx not running"
            sudo systemctl disable nginx 2>/dev/null || echo "nginx already disabled"
            
            # Backup current state
            echo "💾 Creating deployment backup..."
            BACKUP_DIR="/opt/backups/$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p "$BACKUP_DIR"
            
            # Pull latest images
            echo "� Pulling latest Docker images..."
            docker pull ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            
            # Execute deployment script
            echo "🔄 Executing deployment update..."
            cd scripts || {
              echo "❌ Scripts directory not found"
              exit 1
            }
            
            # Set image tag for deployment script
            export NEW_IMAGE_TAG="${{ needs.validation.outputs.image-tag }}"
            ./update-image.sh || {
              echo "❌ Deployment script failed"
              echo "🔄 Attempting rollback..."
              docker-compose down || true
              docker-compose up -d || echo "❌ Rollback failed"
              exit 1
            }
            
            # Verification phase
            echo "🔍 Verifying deployment..."
            cd /opt/hanaya-shop
            
            # Wait for containers to be ready
            echo "⏳ Waiting for containers to start..."
            sleep 10
            
            # Check container status
            if docker ps --filter name=hanaya --format "{{.Names}}" | grep -q hanaya; then
              echo "✅ Containers are running:"
              docker ps --filter name=hanaya --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            else
              echo "❌ No hanaya containers found running"
              exit 1
            fi
            
            # Health check with retry
            echo "🏥 Performing health checks..."
            RETRY_COUNT=0
            MAX_RETRIES=6
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f --max-time 10 http://localhost > /dev/null 2>&1; then
                echo "✅ Application is healthy and responding!"
                echo "🌐 Website is live with latest updates!"
                
                # Additional checks
                echo "📊 Application metrics:"
                docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | head -3
                
                echo "🎉 Production deployment completed successfully!"
                exit 0
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "⏳ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 5s..."
                sleep 5
              fi
            done
            
            echo "⚠️ Health checks failed after $MAX_RETRIES attempts"
            echo "💡 Deployment completed but application may need manual verification"
            echo "🔍 Check logs: docker logs hanaya-web"
            echo "�️ Try clearing browser cache (Ctrl+Shift+R)"
            
          DEPLOYMENT_SCRIPT

      - name: Post-deployment validation
        run: |
          echo "✅ Deployment pipeline completed!"
          echo "🐳 Docker Image: ${{ env.DOCKER_IMAGE }}:${{ needs.validation.outputs.image-tag }}"
          echo "🌐 Environment: ${{ needs.validation.outputs.deploy-env }}"
          
          if [[ "${{ needs.validation.outputs.deploy-env }}" == "production" ]]; then
            echo "🚀 Production URL: http://www.hanayashop.com"
          else
            echo "🚀 Staging URL: http://staging.hanayashop.com"
          fi

  # 📊 Deployment Summary
  summary:
    name: 📊 Deployment Summary
    runs-on: ubuntu-latest
    needs: [validation, comprehensive-tests, docker-build, deploy]
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "## 🚀 Production Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🔍 Validation | ${{ needs.validation.result == 'success' && '✅ Passed' || '❌ Failed' }} | Environment: ${{ needs.validation.outputs.deploy-env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🧪 Tests | ${{ needs.comprehensive-tests.result == 'success' && '✅ All Passed' || '❌ Failed' }} | Production-ready validation |" >> $GITHUB_STEP_SUMMARY
          echo "| 🐳 Docker Build | ${{ needs.docker-build.result == 'success' && '✅ Built & Pushed' || '❌ Failed' }} | Tag: ${{ needs.validation.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 🚀 Deployment | ${{ needs.deploy.result == 'success' && '✅ Deployed' || needs.deploy.result == 'skipped' && '⏭️ Skipped (PR)' || '❌ Failed' }} | Target: ${{ needs.validation.outputs.deploy-env }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "### 🎉 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "The application has been successfully deployed to ${{ needs.validation.outputs.deploy-env }}." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- 🌐 Verify the application at the deployment URL" >> $GITHUB_STEP_SUMMARY
            echo "- 📊 Monitor application metrics and logs" >> $GITHUB_STEP_SUMMARY
            echo "- 🔄 Update documentation if needed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.validation.outputs.is-pr }}" == "true" ]]; then
            echo "### ✅ PR Validation Complete" >> $GITHUB_STEP_SUMMARY
            echo "All tests passed! This PR is ready for review and merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ Deployment Issues" >> $GITHUB_STEP_SUMMARY
            echo "Some stages failed. Please review the logs and retry if necessary." >> $GITHUB_STEP_SUMMARY
          fi